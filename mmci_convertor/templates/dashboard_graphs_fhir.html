<!-- html page generated by ChatGPT and customized -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convector</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body onload="checkStandard({{ standard }})">
    <div class="container">
        <div class="sidebar">
                <h2>FHIR dashboard</h2>
                <ul>
                    <li>
                        <form action="/view_reports_fhir" method="POST">
                            <button type="submit" class="view">View reports</button>
                        </form>
                    </li>
                    <li>
                        <form action="/view_graphs_fhir" method="POST">
                            <button type="submit" class="view">View graphs</button>
                        </form>
                    </li>
                    <li>
                        <form action="/view_failures_fhir" method="POST">
                            <button type="submit" class="view">View failures</button>
                        </form>
                    </li>
                </ul>
                <ul>
                    <li>
                        <button class="view">Download reports</button>
                    </li>
                    <li>
                        <button class="view" onclick="downloadGraphsFhirZIP()">Download graphs</button>
                    </li>
                    <li>
                        <button class="view" onclick="downloadFailuresFhirZIP()">Download failures</button>
                    </li>
                </ul>
                <ul>
                    <li id="view_dashboard" style="border-bottom: 4px solid white; padding-bottom: 16px;">
                        <form action="/go_to_dashboard_omop" method="POST">
                            <button type="submit" name="action" class="view">View OMOP dashboard</button>
                        </form>
                    </li>
                </ul>
        </div>
        <div class="main-content" id="main-content">
            <h1>FHIR graphs</h1>
        </div>
    </div>
    <script>
        if (standard != "both") {
            document.getElementById("view_dashboard").remove();
        }

        function downloadGraphsFhirZIP() {
            window.location.href = '/download_graphs_fhir_zip';
        }

        function downloadFailuresFhirZIP() {
            window.location.href = '/download_failures_fhir_zip';
        }
    </script>

    <script>
        function pollSessionValue() {
            const intervalId = setInterval(() => {
                fetch('/check_graphs_done')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                        })
                    .then(data => {
                        const done = data["response"];
                        const graphs = data["graphs"];

                        if (done == true) {
                            addNewDiv(graphs);
                            }
                            clearInterval(intervalId);
                        })
                    .catch(error => console.error('Error:', error));
            }, 30000); //TODO first pool after five second, then 10 second and then 30 seconds till the end
        }

        function addNewDiv(graphs) {
            const container = document.getElementById("main-content");
            for (let i = 0; i < graphs.length; i++) {
                const newDiv = document.createElement('div');
                newDiv.id = "graph".concat("-", i.toString());
                newDiv.className = "graph-container";
                newDiv.style.cssText = "height: 400px;";
                container.appendChild(newDiv);

                const graphJson = graphs.at(i);
                const graph = JSON.parse(graphJson);
                const plotData = graph.data;
                const plotLayout = graph.layout;
                Plotly.newPlot('graph'.concat("-", i.toString()), plotData, plotLayout);
            }
        }
        window.onload = function() {
            pollSessionValue();
        };
    </script>

</body>
</html>
